<!DOCTYPE html>
<html>
  <head>
    <style>
      * {
      --color-dark: #2D3943;
      --color-light: #f0f0f0;
    }
    
    .console {
      background-color: var(--color-dark);
      padding: 5px;
      border-radius: 5px;
      max-height: 80vw;
      overflow-y: auto;
      font-family: monospace;
    }
    .logs {
      padding-right: 0;
      padding-left: 2%;
    }
    .logs li {
      margin: 7px 0 7px 0;
      color: var(--color-light);
    }
    .logs li::marker {
      color: #777;
    }
    .time {
      color: #2d87d3;
      margin-right: 6px;
    }
    </style>
  </head>
<body>

  <h1>Control Panel</h1>
    
  <p>
    You can execute some actions of you're bot through this manually. You shouldn't use this panel if you're token currently is in use.
    <br />
    The userscript for everyone is available <a href="" target="_blank">Here (coming soon)</a>.
  </p>

  <button onclick='sendPing()' id="ping" disabled>Ping</button>
  <button onclick="getPixel(this)" id="pixel" disabled>Next pixel to paint</button>

  <br />
  <br />

  <div class="console">
    <ol class="logs">
    </ol>
  </div>

  <script>
    class Log {
      constructor() {
        return this;
      }
      format(date) {
        function fillEmpty(num) {
          return num < 10 ? "0" + num : num;
        }
        return fillEmpty(date.getHours()) + ":" + fillEmpty(date.getMinutes()) + ":" + fillEmpty(date.getSeconds());
      }
      log(message) {
        message = (typeof message != "string") ? JSON.stringify(message) : message;
        var console = document.querySelector(".logs");
        if (messageCount == 0) {
          console.innerHTML = "";
        }
        var time = document.createElement("span");
        time.classList.add("time");
        time.innerHTML = "[" + this.format(new Date()) + "]";
        var li = document.createElement("li");
        li.innerHTML = message;

        li.prepend(time);
        console.appendChild(li);
        messageCount++;
        li.scrollIntoView();
      }
      error(message) {
        message = (typeof message != "string") ? JSON.stringify(message) : message;
        var console = document.querySelector(".logs");
        if (messageCount == 0) {
          console.innerHTML = "";
        }
        var time = document.createElement("span");
        time.classList.add("time");
        time.innerHTML = "[" + this.format(new Date()) + "]";
        var li = document.createElement("li");
        li.style.color = "#F62451";
        li.innerHTML = message;

        li.prepend(time);
        console.appendChild(li);
        messageCount++;
        li.scrollIntoView();
      }
      success(message) {
        message = (typeof message != "string") ? JSON.stringify(message) : message;
        var console = document.querySelector(".logs");
        if (messageCount == 0) {
          console.innerHTML = "";
        }
        var time = document.createElement("span");
        time.classList.add("time");
        time.innerHTML = "[" + this.format(new Date()) + "]";
        var li = document.createElement("li");
        li.style.color = "#1fd78d";
        li.innerHTML = message;

        li.prepend(time);
        console.appendChild(li);
        messageCount++;
        li.scrollIntoView();
      }
      warn(message) {
        message = (typeof message != "string") ? JSON.stringify(message) : message;
        var console = document.querySelector(".logs");
        if (messageCount == 0) {
          console.innerHTML = "";
        }
        var time = document.createElement("span");
        time.classList.add("time");
        time.innerHTML = "[" + this.format(new Date()) + "]";
        var li = document.createElement("li");
        li.style.color = "#EB7B59";
        li.innerHTML = message;

        li.prepend(time);
        console.appendChild(li);
        messageCount++;
        li.scrollIntoView();
      }
    }
    const buttons = [document.querySelector("button#ping"), document.querySelector("button#pixel")];
    var socket;
    var messageCount = -1;

    const Logs = new Log();
    function log(msg) {return Logs.log(msg);}
    function error(msg) {return Logs.error(msg);}
    function success(msg) {return Logs.success(msg)}
    function warn(msg) {return Logs.warn(msg);}
    
    log("Initializing...");
    window.addEventListener("load", function () {
      log("Searching for bot token in cookies...");
      const token = getCookie("token") || "";
      if (!token) {
        error("No token found. Please login <a href='../'>here</a> to get a token.")
        log("Connecting aborted");
        return;
      }
      log("Token found! Using: " + token);
      const url = location.href.replace("https", "wss").replace("http", "ws").replace("panel", "") + 'api/ws/';
      log("Connecting to '" + url + "'...");

      socket = new WebSocket(url + token);
      socket.onopen = () => {
        console.log("Connection to Private Rick/Commander Astley established!");
        success("Connection to Private Rick/Commander Astley established!");
        log("Ready to send/receive commands!");
        buttons.forEach(button => button.disabled = false);
      };
      socket.onclose = () => {
        console.error("Connection closed unexpectedly...");
        error("Connection closed unexpectedly...")
      };
      socket.onerror = (e) => {
        console.log("Error: ", e);
        error("An error occured in the connection! " + JSON.stringify(e));
      };

      socket.onmessage = (e) => {
        console.log("Message: ", JSON.parse(e.data));
        let data = JSON.parse(e.data);
        switch(data.type) {
          case "error":
            warn(e.data);
          break;
          case "unexpected-error":
            error(e.data);
          break;
          default:
            log(e.data);
          break;
        }
      };
    });
    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function sendPing() {
      socket.send(JSON.stringify({ action: "ping" }))
      log("Ping sent");
    }
    function getPixel(button) {
      socket.send(JSON.stringify({ action: "nextPixel" }));
    }
  </script>
</body>
</html>
